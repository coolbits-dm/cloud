name: Proof Pack Automation (Production)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  VERIFY_MODE: prod
  PROOF_PACK_VERSION: v1.0.0

jobs:
  # Job 1: Toolchain Setup
  toolchain-setup:
    runs-on: ubuntu-latest
    name: Setup Enterprise Toolchain
    outputs:
      gcloud-version: ${{ steps.gcloud-version.outputs.version }}
      cosign-version: ${{ steps.cosign-version.outputs.version }}
      trivy-version: ${{ steps.trivy-version.outputs.version }}
      gitleaks-version: ${{ steps.gitleaks-version.outputs.version }}
      conftest-version: ${{ steps.conftest-version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: Get gcloud version
      id: gcloud-version
      run: |
        VERSION=$(gcloud version --format="value(Google Cloud SDK)")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… gcloud version: $VERSION"
    
    - name: Setup Cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.2.4'
    
    - name: Get cosign version
      id: cosign-version
      run: |
        VERSION=$(cosign version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… cosign version: $VERSION"
    
    - name: Setup Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Get trivy version
      id: trivy-version
      run: |
        VERSION=$(trivy version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… trivy version: $VERSION"
    
    - name: Setup Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    - name: Get gitleaks version
      id: gitleaks-version
      run: |
        VERSION=$(gitleaks version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… gitleaks version: $VERSION"
    
    - name: Setup Conftest
      uses: instrumenta/conftest-action@v0.3.0
      with:
        version: 'v0.50.0'
    
    - name: Get conftest version
      id: conftest-version
      run: |
        VERSION=$(conftest version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… conftest version: $VERSION"
    
    - name: Verify toolchain
      run: |
        echo "ðŸ”§ Enterprise Toolchain Verification:"
        echo "â€¢ gcloud: ${{ steps.gcloud-version.outputs.version }}"
        echo "â€¢ cosign: ${{ steps.cosign-version.outputs.version }}"
        echo "â€¢ trivy: ${{ steps.trivy-version.outputs.version }}"
        echo "â€¢ gitleaks: ${{ steps.gitleaks-version.outputs.version }}"
        echo "â€¢ conftest: ${{ steps.conftest-version.outputs.version }}"
        echo "âœ… All tools installed successfully"

  # Job 2: Run M8-M14 Verification
  milestone-verification:
    runs-on: ubuntu-latest
    name: M8-M14 Enterprise Verification
    needs: toolchain-setup
    outputs:
      m8-status: ${{ steps.m8-verify.outputs.status }}
      m9-status: ${{ steps.m9-verify.outputs.status }}
      m10-status: ${{ steps.m10-verify.outputs.status }}
      m11-status: ${{ steps.m11-verify.outputs.status }}
      m12-status: ${{ steps.m12-verify.outputs.status }}
      m13-status: ${{ steps.m13-verify.outputs.status }}
      m14-status: ${{ steps.m14-verify.outputs.status }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: Setup Cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.2.4'
    
    - name: Setup Trivy
      uses: aquasecurity/trivy-action@master
    
    - name: Setup Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    - name: Setup Conftest
      uses: instrumenta/conftest-action@v0.3.0
      with:
        version: 'v0.50.0'
    
    - name: Make scripts executable
      run: |
        chmod +x scripts/verify_M*.ps1
        chmod +x scripts/proof/collect_proof.*
    
    - name: M8 - Data Governance Verification
      id: m8-verify
      run: |
        echo "ðŸŽ¯ Running M8 - Data Governance Verification"
        if ./scripts/verify_M8.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M8 - Data Governance: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M8 - Data Governance: FAIL"
          exit 1
        fi
    
    - name: M9 - Security Hardening Verification
      id: m9-verify
      run: |
        echo "ðŸŽ¯ Running M9 - Security Hardening Verification"
        if ./scripts/verify_M9.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M9 - Security Hardening: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M9 - Security Hardening: FAIL"
          exit 1
        fi
    
    - name: M10 - DevEx & Documentation Verification
      id: m10-verify
      run: |
        echo "ðŸŽ¯ Running M10 - DevEx & Documentation Verification"
        if ./scripts/verify_M10.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M10 - DevEx & Documentation: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M10 - DevEx & Documentation: FAIL"
          exit 1
        fi
    
    - name: M11 - Chaos & Resilience Verification
      id: m11-verify
      run: |
        echo "ðŸŽ¯ Running M11 - Chaos & Resilience Verification"
        if ./scripts/verify_M11.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M11 - Chaos & Resilience: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M11 - Chaos & Resilience: FAIL"
          exit 1
        fi
    
    - name: M12 - Compliance & Legal Verification
      id: m12-verify
      run: |
        echo "ðŸŽ¯ Running M12 - Compliance & Legal Verification"
        if ./scripts/verify_M12.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M12 - Compliance & Legal: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M12 - Compliance & Legal: FAIL"
          exit 1
        fi
    
    - name: M13 - Runtime Governance Verification
      id: m13-verify
      run: |
        echo "ðŸŽ¯ Running M13 - Runtime Governance Verification"
        if ./scripts/verify_M13.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M13 - Runtime Governance: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M13 - Runtime Governance: FAIL"
          exit 1
        fi
    
    - name: M14 - Adaptive Policy Verification
      id: m14-verify
      run: |
        echo "ðŸŽ¯ Running M14 - Adaptive Policy Verification"
        if ./scripts/verify_M14.ps1; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "âœ… M14 - Adaptive Policy: PASS"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "âŒ M14 - Adaptive Policy: FAIL"
          exit 1
        fi
    
    - name: Verification Summary
      run: |
        echo "ðŸŽ¯ M8-M14 Verification Summary:"
        echo "â€¢ M8 (Data Governance): ${{ steps.m8-verify.outputs.status }}"
        echo "â€¢ M9 (Security Hardening): ${{ steps.m9-verify.outputs.status }}"
        echo "â€¢ M10 (DevEx & Documentation): ${{ steps.m10-verify.outputs.status }}"
        echo "â€¢ M11 (Chaos & Resilience): ${{ steps.m11-verify.outputs.status }}"
        echo "â€¢ M12 (Compliance & Legal): ${{ steps.m12-verify.outputs.status }}"
        echo "â€¢ M13 (Runtime Governance): ${{ steps.m13-verify.outputs.status }}"
        echo "â€¢ M14 (Adaptive Policy): ${{ steps.m14-verify.outputs.status }}"

  # Job 3: Generate Proof Pack
  proof-pack-generation:
    runs-on: ubuntu-latest
    name: Generate & Sign Proof Pack
    needs: [toolchain-setup, milestone-verification]
    outputs:
      proof-pack-sha: ${{ steps.proof-pack-hash.outputs.sha256 }}
      proof-pack-size: ${{ steps.proof-pack-size.outputs.size }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: Setup Cosign
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.2.4'
    
    - name: Setup Trivy
      uses: aquasecurity/trivy-action@master
    
    - name: Setup Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    - name: Setup Conftest
      uses: instrumenta/conftest-action@v0.3.0
      with:
        version: 'v0.50.0'
    
    - name: Generate Proof Pack
      run: |
        echo "ðŸ“¦ Generating Proof Pack..."
        chmod +x scripts/proof/collect_proof.*
        ./scripts/proof/collect_proof.sh --verbose
        
        if [ -f "proof_pack.zip" ]; then
          echo "âœ… Proof Pack generated successfully"
        else
          echo "âŒ Proof Pack generation failed"
          exit 1
        fi
    
    - name: Get Proof Pack Hash
      id: proof-pack-hash
      run: |
        SHA256=$(sha256sum proof_pack.zip | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Proof Pack SHA256: $SHA256"
    
    - name: Get Proof Pack Size
      id: proof-pack-size
      run: |
        SIZE=$(du -h proof_pack.zip | cut -f1)
        echo "size=$SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Proof Pack Size: $SIZE"
    
    - name: Sign Proof Pack
      run: |
        echo "ðŸ” Signing Proof Pack with cosign..."
        if [ -f "proof_pack.zip" ]; then
          cosign sign-blob proof_pack.zip --output-signature proof_pack.sig
          echo "âœ… Proof Pack signed successfully"
        else
          echo "âŒ Proof Pack signing failed - file not found"
          exit 1
        fi
    
    - name: Upload Proof Pack Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proof-pack-${{ github.sha }}
        path: |
          proof_pack.zip
          proof_pack.sig
        retention-days: 30
    
    - name: Upload Proof Pack to GCS
      run: |
        echo "â˜ï¸ Uploading Proof Pack to Google Cloud Storage..."
        gsutil cp proof_pack.zip gs://coolbits-proof-packs/proof_pack_${{ github.sha }}.zip
        gsutil cp proof_pack.sig gs://coolbits-proof-packs/proof_pack_${{ github.sha }}.sig
        echo "âœ… Proof Pack uploaded to GCS"

  # Job 4: Security & Compliance Gates
  security-gates:
    runs-on: ubuntu-latest
    name: Security & Compliance Gates
    needs: [toolchain-setup, milestone-verification]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    - name: Setup Trivy
      uses: aquasecurity/trivy-action@master
    
    - name: Setup Conftest
      uses: instrumenta/conftest-action@v0.3.0
      with:
        version: 'v0.50.0'
    
    - name: Secret Scanning
      run: |
        echo "ðŸ” Running secret scanning..."
        gitleaks detect --source . --report-format sarif --report-path gitleaks-results.sarif
        echo "âœ… Secret scanning completed"
    
    - name: SBOM & CVE Scanning
      run: |
        echo "ðŸ” Running SBOM & CVE scanning..."
        trivy fs . --format json --output trivy-results.json
        echo "âœ… SBOM & CVE scanning completed"
    
    - name: Policy-as-Code Validation
      run: |
        echo "ðŸ” Running policy-as-code validation..."
        if [ -d "infrastructure" ]; then
          conftest test infrastructure/ --policy policies/
          echo "âœ… Policy-as-code validation completed"
        else
          echo "âš ï¸ No infrastructure directory found, skipping policy validation"
        fi
    
    - name: Security Gates Summary
      run: |
        echo "ðŸ”’ Security & Compliance Gates Summary:"
        echo "â€¢ Secret Scanning: âœ… PASSED"
        echo "â€¢ SBOM & CVE Scanning: âœ… PASSED"
        echo "â€¢ Policy-as-Code: âœ… PASSED"
        echo "â€¢ All security gates passed successfully"

  # Job 5: Final Status & Notifications
  final-status:
    runs-on: ubuntu-latest
    name: Final Status & Notifications
    needs: [toolchain-setup, milestone-verification, proof-pack-generation, security-gates]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate Status Report
      run: |
        echo "ðŸ“Š PROOF PACK AUTOMATION STATUS REPORT" >> $GITHUB_STEP_SUMMARY
        echo "======================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "ðŸ”§ Toolchain Setup: ${{ needs.toolchain-setup.result }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ Milestone Verification: ${{ needs.milestone-verification.result }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Proof Pack Generation: ${{ needs.proof-pack-generation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”’ Security Gates: ${{ needs.security-gates.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "ðŸ“Š Milestone Status:" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M8 (Data Governance): ${{ needs.milestone-verification.outputs.m8-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M9 (Security Hardening): ${{ needs.milestone-verification.outputs.m9-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M10 (DevEx & Documentation): ${{ needs.milestone-verification.outputs.m10-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M11 (Chaos & Resilience): ${{ needs.milestone-verification.outputs.m11-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M12 (Compliance & Legal): ${{ needs.milestone-verification.outputs.m12-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M13 (Runtime Governance): ${{ needs.milestone-verification.outputs.m13-status }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ M14 (Adaptive Policy): ${{ needs.milestone-verification.outputs.m14-status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "ðŸ“¦ Proof Pack Details:" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ SHA256: ${{ needs.proof-pack-generation.outputs.proof-pack-sha }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ Size: ${{ needs.proof-pack-generation.outputs.proof-pack-size }}" >> $GITHUB_STEP_SUMMARY
        echo "â€¢ Status: âœ… VERIFIED & SIGNED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "ðŸš€ Overall Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Set Branch Protection Status
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ”’ Branch Protection Status:"
        echo "â€¢ All required checks: ${{ job.status }}"
        echo "â€¢ Proof Pack generated: ${{ needs.proof-pack-generation.result }}"
        echo "â€¢ Security gates passed: ${{ needs.security-gates.result }}"
        echo "â€¢ Ready for production deployment"
