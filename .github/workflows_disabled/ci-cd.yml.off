name: CI/CD
on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'panel/**'
      - 'artifacts/**'
      - 'report/**'
      - '**/*.md'
      - '**/*.MD'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'panel/**'
      - 'artifacts/**'
      - 'report/**'
      - '**/*.md'
      - '**/*.MD'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    name: verify (node+python+actionlint)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install actionlint
        run: |
          curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash | bash -s -- -b ./.bin
          echo "./.bin" >> $GITHUB_PATH
      - name: Lint workflows
        run: actionlint
      - name: Install deps (node)
        run: npm ci || true
      - name: Install deps (python)
        run: python -m pip install -U pip && pip install -r requirements.txt || true
      - name: Unit tests
        run: |
          pytest -q || echo "pytest soft-fail in dev"
          echo "verify done"

  release:
    name: release (prod-only)
    if: ${{ env.CB_BILLING_MODE == 'prod' && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - run: echo "Release gated by CB_BILLING_MODE=prod"